<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diary, To-Do & Mood Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .calendar-card { min-height: 80px; transition: 0.2s; }
        .has-entry::after { content: '‚Ä¢'; color: #3b82f6; font-size: 20px; display: block; line-height: 0; }
        .hidden { display: none; }
    </style>
</head>
<body class="pb-10">

    <nav class="bg-white border-b p-4 mb-6 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-600 flex items-center gap-2 cursor-pointer" onclick="showCalendarView()">
                <i data-lucide="book-heart"></i> My Daily Life
            </h1>
            <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">Local Storage Enabled üîí</span>
        </div>
    </nav>

    <main class="container mx-auto px-4">
        
        <div id="calendar-view" class="max-w-4xl mx-auto space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-left"></i></button>
                    <h2 id="monthYearLabel" class="text-xl font-bold text-gray-700"></h2>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-right"></i></button>
                </div>

                <div class="grid grid-cols-7 gap-2 mb-2">
                    <div class="text-center text-xs font-bold text-red-400">‡∏≠‡∏≤</div>
                    <div class="text-center text-xs font-bold text-gray-400">‡∏à</div>
                    <div class="text-center text-xs font-bold text-gray-400">‡∏≠</div>
                    <div class="text-center text-xs font-bold text-gray-400">‡∏û</div>
                    <div class="text-center text-xs font-bold text-gray-400">‡∏û‡∏§</div>
                    <div class="text-center text-xs font-bold text-gray-400">‡∏®</div>
                    <div class="text-center text-xs font-bold text-blue-400">‡∏™</div>
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-2"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                </h3>
                <div class="h-48 w-full">
                    <canvas id="moodChart"></canvas>
                </div>
            </div>
        </div>

        <div id="entry-view" class="hidden max-w-2xl mx-auto">
            <button onclick="showCalendarView()" class="mb-4 flex items-center gap-2 text-blue-600 hover:bg-blue-50 px-3 py-1 rounded-lg transition">
                <i data-lucide="arrow-left" class="w-4"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
            </button>
            
            <div class="bg-white p-8 rounded-3xl shadow-xl space-y-8">
                <div>
                    <h2 id="viewingDateText" class="text-2xl font-bold text-gray-800"></h2>
                    <p class="text-sm text-gray-400" id="entryStatus">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</p>
                </div>

                <div class="bg-gray-50 p-5 rounded-2xl">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-3">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</label>
                    <div class="flex justify-around" id="moodPicker">
                        <button onclick="setMood('happy')" id="btn-happy" class="text-3xl p-3 rounded-2xl hover:bg-white transition" title="‡∏î‡∏µ‡πÉ‡∏à">üòä</button>
                        <button onclick="setMood('neutral')" id="btn-neutral" class="text-3xl p-3 rounded-2xl hover:bg-white transition" title="‡πÄ‡∏â‡∏¢‡πÜ">üòê</button>
                        <button onclick="setMood('sad')" id="btn-sad" class="text-3xl p-3 rounded-2xl hover:bg-white transition" title="‡πÄ‡∏®‡∏£‡πâ‡∏≤">üò¢</button>
                        <button onclick="setMood('angry')" id="btn-angry" class="text-3xl p-3 rounded-2xl hover:bg-white transition" title="‡πÇ‡∏Å‡∏£‡∏ò/‡πÅ‡∏¢‡πà">üò°</button>
                    </div>
                </div>

                <div class="border-t pt-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2">
                        <i data-lucide="list-todo" class="w-4"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (To-Do)
                    </label>
                    <div id="todoList" class="space-y-2 mb-4"></div>
                    <div class="flex gap-2">
                        <input id="todoInput" type="text" class="flex-1 bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-400" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà...">
                        <button onclick="addTodo()" class="bg-blue-100 text-blue-600 p-3 rounded-xl hover:bg-blue-200"><i data-lucide="plus"></i></button>
                    </div>
                </div>

                <div class="border-t pt-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà</label>
                    <textarea id="diaryBody" rows="6" class="w-full p-4 bg-gray-50 rounded-2xl focus:ring-2 focus:ring-blue-400 outline-none" placeholder="‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢..."></textarea>
                    <input id="tagInput" type="text" class="w-full mt-3 p-2 text-sm italic border-b outline-none" placeholder="#‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å">
                </div>

                <div class="flex gap-3">
                    <button onclick="saveAll()" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-100 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button onclick="deleteEntry()" class="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100"><i data-lucide="trash-2"></i></button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- State Management ---
        let db = JSON.parse(localStorage.getItem('diary_v3_db')) || {};
        let viewDate = new Date();
        let activeDateKey = "";
        let currentMood = "";
        let currentTodos = [];
        let chartInstance = null;

        function init() {
            lucide.createIcons();
            renderCalendar();
            updateMoodChart();
        }

        // --- Calendar Logic ---
        function renderCalendar() {
            const grid = document.getElementById('calendarDays');
            grid.innerHTML = '';
            const y = viewDate.getFullYear();
            const m = viewDate.getMonth();
            document.getElementById('monthYearLabel').innerText = `${new Intl.DateTimeFormat('th-TH', {month:'long', year:'numeric'}).format(viewDate)}`;

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const hasEntry = db[dateKey] ? 'has-entry' : '';
                const isToday = new Date().toDateString() === new Date(y, m, d).toDateString() ? 'ring-2 ring-blue-400 bg-blue-50' : 'bg-white';
                
                grid.innerHTML += `
                    <div onclick="openEntry('${dateKey}')" class="calendar-card ${isToday} border rounded-2xl p-2 cursor-pointer hover:shadow-md flex flex-col items-center justify-center gap-1 ${hasEntry}">
                        <span class="font-bold text-gray-700">${d}</span>
                        <span class="text-[10px]">${getMoodEmoji(db[dateKey]?.mood)}</span>
                    </div>
                `;
            }
        }

        function getMoodEmoji(m) {
            const map = { happy: 'üòä', neutral: 'üòê', sad: 'üò¢', angry: 'üò°' };
            return map[m] || '';
        }

        // --- Entry View Logic ---
        function openEntry(dateKey) {
            activeDateKey = dateKey;
            document.getElementById('calendar-view').classList.add('hidden');
            document.getElementById('entry-view').classList.remove('hidden');
            document.getElementById('viewingDateText').innerText = new Date(dateKey).toLocaleDateString('th-TH', {dateStyle:'full'});
            
            const entry = db[dateKey] || { body: '', mood: '', tags: '', todos: [] };
            document.getElementById('diaryBody').value = entry.body || '';
            document.getElementById('tagInput').value = entry.tags || '';
            document.getElementById('entryStatus').innerText = db[dateKey] ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ' + new Date(entry.updatedAt).toLocaleTimeString() : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            
            currentMood = entry.mood || '';
            currentTodos = entry.todos || [];
            
            highlightMood(currentMood);
            renderTodos();
            window.scrollTo(0,0);
        }

        function showCalendarView() {
            document.getElementById('calendar-view').classList.remove('hidden');
            document.getElementById('entry-view').classList.add('hidden');
            renderCalendar();
            updateMoodChart();
        }

        // --- To-Do Logic ---
        function renderTodos() {
            const container = document.getElementById('todoList');
            container.innerHTML = currentTodos.map((t, i) => `
                <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl group">
                    <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTodo(${i})" class="w-5 h-5 rounded-full accent-blue-600">
                    <span class="flex-1 ${t.done ? 'line-through text-gray-400' : 'text-gray-700'}">${t.text}</span>
                    <button onclick="removeTodo(${i})" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function addTodo() {
            const input = document.getElementById('todoInput');
            if (!input.value.trim()) return;
            currentTodos.push({ text: input.value, done: false });
            input.value = '';
            renderTodos();
        }

        function toggleTodo(i) { currentTodos[i].done = !currentTodos[i].done; renderTodos(); }
        function removeTodo(i) { currentTodos.splice(i, 1); renderTodos(); }

        // --- Mood Logic ---
        function setMood(m) { currentMood = m; highlightMood(m); }
        function highlightMood(m) {
            ['happy', 'neutral', 'sad', 'angry'].forEach(id => {
                document.getElementById('btn-'+id).classList.toggle('ring-4', id === m);
                document.getElementById('btn-'+id).classList.toggle('ring-blue-100', id === m);
                document.getElementById('btn-'+id).classList.toggle('bg-white', id === m);
            });
        }

        // --- Save Logic ---
        function saveAll() {
            db[activeDateKey] = {
                body: document.getElementById('diaryBody').value,
                mood: currentMood,
                tags: document.getElementById('tagInput').value,
                todos: currentTodos,
                updatedAt: new Date().toISOString()
            };
            localStorage.setItem('diary_v3_db', JSON.stringify(db));
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®");
            showCalendarView();
        }

        function deleteEntry() {
            if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                delete db[activeDateKey];
                localStorage.setItem('diary_v3_db', JSON.stringify(db));
                showCalendarView();
            }
        }

        // --- Chart Logic ---
        function updateMoodChart() {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days.push(d.toISOString().split('T')[0]);
            }

            const moodScores = { happy: 3, neutral: 2, sad: 1, angry: 0 };
            const chartData = last7Days.map(date => db[date] ? moodScores[db[date].mood] : null);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => d.split('-')[2] + '/' + d.split('-')[1]),
                    datasets: [{
                        label: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å',
                        data: chartData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 3, ticks: { 
                            callback: value => ['üò°','üò¢','üòê','üòä'][value],
                            stepSize: 1 
                        } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function changeMonth(dir) { viewDate.setMonth(viewDate.getMonth() + dir); renderCalendar(); }

        window.onload = init;
    </script>
</body>
</html>