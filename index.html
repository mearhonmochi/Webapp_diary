<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Personal AI Diary & Mood Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .calendar-card { min-height: 90px; transition: transform 0.2s, box-shadow 0.2s; }
        .calendar-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .hidden { display: none; }
        .mood-active { background-color: #dbeafe; ring: 2px; ring-color: #3b82f6; border-radius: 1rem; }
    </style>
</head>
<body class="pb-20">

    <nav class="bg-white border-b p-4 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto flex flex-wrap justify-between items-center gap-4">
            <h1 class="text-xl font-bold text-blue-600 flex items-center gap-2 cursor-pointer" onclick="showCalendarView()">
                <i data-lucide="sparkles"></i> AI Daily Diary
            </h1>
            
            <div class="flex items-center gap-2">
                <div class="relative">
                    <input type="text" id="searchTag" onkeyup="searchByTag()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ #‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å..." class="pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-full text-sm outline-none focus:ring-2 focus:ring-blue-400 w-40 md:w-64">
                    <i data-lucide="hash" class="w-4 h-4 absolute left-3 top-2.5 text-gray-400"></i>
                </div>
                <button onclick="downloadJSON()" class="p-2 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition" title="‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON">
                    <i data-lucide="download" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 mt-8">
        
        <div id="calendar-view" class="max-w-5xl mx-auto space-y-8">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-8">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="chevron-left"></i></button>
                        <h2 id="monthYearLabel" class="text-xl font-bold text-gray-800"></h2>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="chevron-right"></i></button>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-3">
                        </div>
                </div>

                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-6 flex items-center gap-2">
                        <i data-lucide="activity" class="text-blue-500"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </h3>
                    <div class="flex-1 min-h-[250px]">
                        <canvas id="moodChart"></canvas>
                    </div>
                    <p class="text-xs text-center text-gray-400 mt-4 italic">‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô</p>
                </div>
            </div>
        </div>

        <div id="entry-view" class="hidden max-w-3xl mx-auto">
            <button onclick="showCalendarView()" class="mb-6 flex items-center gap-2 text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-xl transition font-semibold">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
            </button>
            
            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl space-y-8 border border-gray-50">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-[1.5rem] border-l-8 border-blue-500 shadow-sm">
                    <div class="flex items-center gap-2 text-blue-600 mb-2 font-bold text-sm tracking-wide">
                        <i data-lucide="brain-circuit" class="w-4 h-4"></i> ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å AI
                    </div>
                    <p id="aiQuestion" class="text-blue-900 text-lg font-medium"></p>
                </div>

                <div class="flex flex-wrap justify-between items-end gap-2">
                    <h2 id="viewingDateText" class="text-3xl font-bold text-gray-800"></h2>
                    <span id="saveStatus" class="text-xs text-gray-400 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-widest">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</label>
                        <div id="imagePreview" onclick="document.getElementById('fileInput').click()" class="w-full aspect-video bg-gray-50 rounded-[1.5rem] flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-200 cursor-pointer hover:bg-gray-100 transition group">
                            <div class="text-center group-hover:scale-110 transition">
                                <i data-lucide="image-plus" class="w-8 h-8 text-gray-300 mx-auto mb-2"></i>
                                <p class="text-xs text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                            </div>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImage(event)">
                    </div>

                    <div class="space-y-3">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-widest">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
                        <div class="grid grid-cols-3 gap-2 bg-gray-50 p-3 rounded-[1.5rem]" id="moodPicker">
                            <button onclick="setMood('happy')" id="m-happy" class="text-4xl p-4 transition-all duration-300 hover:scale-110 grayscale hover:grayscale-0">üòä</button>
                            <button onclick="setMood('neutral')" id="m-neutral" class="text-4xl p-4 transition-all duration-300 hover:scale-110 grayscale hover:grayscale-0">üòê</button>
                            <button onclick="setMood('sad')" id="m-sad" class="text-4xl p-4 transition-all duration-300 hover:scale-110 grayscale hover:grayscale-0">üò¢</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-widest">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                    <textarea id="diaryBody" rows="6" class="w-full p-6 bg-gray-50 rounded-[1.5rem] border-none focus:ring-2 focus:ring-blue-400 outline-none text-lg shadow-inner" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ..."></textarea>
                    <input id="tagInput" type="text" class="w-full p-2 border-b border-gray-100 italic outline-none text-blue-500 font-medium" placeholder="#‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å ‡πÄ‡∏ä‡πà‡∏ô #‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß #‡∏≠‡∏≤‡∏´‡∏≤‡∏£">
                </div>

                <div class="bg-gray-50 p-6 rounded-[1.5rem] space-y-4">
                    <h3 class="font-bold text-gray-700 flex items-center gap-2"><i data-lucide="list-check" class="w-5 h-5 text-blue-500"></i> ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (To-Do List)</h3>
                    <div id="todoList" class="space-y-2"></div>
                    <div class="flex gap-2">
                        <input id="todoInput" type="text" class="flex-1 bg-white p-3 rounded-xl outline-none shadow-sm" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà...">
                        <button onclick="addTodo()" class="bg-blue-600 text-white px-6 rounded-xl hover:bg-blue-700 transition font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="saveAll()" class="flex-1 bg-blue-600 text-white py-5 rounded-[1.5rem] font-bold shadow-xl shadow-blue-100 hover:bg-blue-700 hover:-translate-y-1 transition-all active:scale-95">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <button onclick="deleteEntry()" class="p-5 bg-red-50 text-red-500 rounded-[1.5rem] hover:bg-red-100 transition">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- State Management ---
        let db = JSON.parse(localStorage.getItem('ai_diary_vfinal')) || {};
        let viewDate = new Date();
        let activeDateKey = "";
        let currentMood = "";
        let currentImage = "";
        let chartInstance = null;

        const aiQuestions = [
            "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏¥‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?",
            "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏≠ '‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å/‡∏ô‡∏≤‡∏á‡πÄ‡∏≠‡∏Å' ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÑ‡∏°?",
            "‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£?",
            "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÜ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏á‡πÑ‡∏´‡∏°?",
            "‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ?",
            "‡∏ñ‡πâ‡∏≤‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô?",
            "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏´‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏∞‡∏à‡∏≥‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å‡∏ô‡∏≤‡∏ô?",
            "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏´‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏±‡∏ô‡∏°‡∏≤‡πÑ‡∏î‡πâ?"
        ];

        function init() {
            lucide.createIcons();
            renderCalendar();
            updateMoodChart();
        }

        // --- Calendar & Navigation ---
        function renderCalendar(filterTag = "") {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const y = viewDate.getFullYear();
            const m = viewDate.getMonth();
            document.getElementById('monthYearLabel').innerText = new Intl.DateTimeFormat('th-TH', {month:'long', year:'numeric'}).format(viewDate);

            // Weekday Headers
            ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'].forEach(d => grid.innerHTML += `<div class="text-center text-xs font-bold text-slate-400 mb-2">${d}</div>`);

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const entry = db[dateKey];
                
                let match = true;
                if(filterTag && (!entry || !entry.tags.includes(filterTag))) match = false;

                const hasEntryClass = entry ? 'border-blue-400 bg-blue-50 ring-2 ring-blue-50' : 'bg-white border-gray-100';
                const opacityClass = !match ? 'opacity-20 scale-90' : 'opacity-100';
                const todayClass = new Date().toISOString().split('T')[0] === dateKey ? 'ring-2 ring-orange-400' : '';

                grid.innerHTML += `
                    <div onclick="openEntry('${dateKey}')" class="calendar-card border rounded-2xl p-2 cursor-pointer flex flex-col items-center justify-center gap-1 ${hasEntryClass} ${opacityClass} ${todayClass}">
                        <span class="font-bold text-slate-700">${d}</span>
                        <span class="text-xl">${entry ? getMoodEmoji(entry.mood) : ''}</span>
                    </div>
                `;
            }
        }

        function getMoodEmoji(m) {
            return { happy: 'üòä', neutral: 'üòê', sad: 'üò¢' }[m] || '';
        }

        // --- Entry View Logic ---
        function openEntry(dateKey) {
            activeDateKey = dateKey;
            const data = db[dateKey] || { body: '', mood: '', tags: '', todos: [], img: '' };
            
            document.getElementById('calendar-view').classList.add('hidden');
            document.getElementById('entry-view').classList.remove('hidden');
            
            // Format Thai Date
            const d = new Date(dateKey);
            document.getElementById('viewingDateText').innerText = d.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('saveStatus').innerText = data.updatedAt ? "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date(data.updatedAt).toLocaleTimeString('th-TH') : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";

            // AI Prompt
            const seed = dateKey.split('-').reduce((a, b) => a + parseInt(b), 0);
            document.getElementById('aiQuestion').innerText = aiQuestions[seed % aiQuestions.length];

            // Load Data
            document.getElementById('diaryBody').value = data.body;
            document.getElementById('tagInput').value = data.tags;
            currentMood = data.mood;
            currentImage = data.img;
            
            // Image Preview
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = data.img ? `<img src="${data.img}" class="w-full h-full object-cover">` : 
                `<div class="text-center"><i data-lucide="image-plus" class="w-8 h-8 text-gray-300 mx-auto mb-2"></i><p class="text-xs text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p></div>`;
            
            highlightMood(currentMood);
            renderTodos(data.todos || []);
            lucide.createIcons();
            window.scrollTo(0, 0);
        }

        function showCalendarView() {
            document.getElementById('calendar-view').classList.remove('hidden');
            document.getElementById('entry-view').classList.add('hidden');
            renderCalendar();
            updateMoodChart();
        }

        // --- Mood & Image Handlers ---
        function setMood(m) {
            currentMood = m;
            highlightMood(m);
        }

        function highlightMood(m) {
            ['happy', 'neutral', 'sad'].forEach(id => {
                const btn = document.getElementById('m-'+id);
                btn.classList.toggle('grayscale-0', id === m);
                btn.classList.toggle('grayscale', id !== m);
                btn.classList.toggle('mood-active', id === m);
                btn.classList.toggle('scale-110', id === m);
            });
        }

        function handleImage(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    currentImage = ev.target.result; // Base64
                    document.getElementById('imagePreview').innerHTML = `<img src="${currentImage}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // --- To-Do List Logic ---
        function renderTodos(todos) {
            const list = document.getElementById('todoList');
            list.innerHTML = (todos || []).map((t, i) => `
                <div class="flex items-center gap-3 bg-white p-3 rounded-xl shadow-sm group">
                    <input type="checkbox" ${t.done?'checked':''} onchange="toggleTodo(${i})" class="w-5 h-5 rounded-md accent-blue-600">
                    <span class="flex-1 text-sm ${t.done?'line-through text-gray-400':''}">${t.text}</span>
                    <button onclick="removeTodo(${i})" class="text-gray-300 hover:text-red-500 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function addTodo() {
            const input = document.getElementById('todoInput');
            if(!input.value.trim()) return;
            const entry = db[activeDateKey] || { todos: [] };
            if(!entry.todos) entry.todos = [];
            entry.todos.push({ text: input.value, done: false });
            db[activeDateKey] = entry; // Update Temp
            renderTodos(entry.todos);
            input.value = '';
        }
        function toggleTodo(i) { db[activeDateKey].todos[i].done = !db[activeDateKey].todos[i].done; renderTodos(db[activeDateKey].todos); }
        function removeTodo(i) { db[activeDateKey].todos.splice(i, 1); renderTodos(db[activeDateKey].todos); }

        // --- Data Persistance ---
        function saveAll() {
            const entryData = {
                body: document.getElementById('diaryBody').value,
                mood: currentMood,
                tags: document.getElementById('tagInput').value,
                img: currentImage,
                todos: (db[activeDateKey] && db[activeDateKey].todos) || [],
                updatedAt: new Date().toISOString()
            };
            
            db[activeDateKey] = entryData;
            localStorage.setItem('ai_diary_vfinal', JSON.stringify(db));
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®");
            showCalendarView();
        }

        function deleteEntry() {
            if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                delete db[activeDateKey];
                localStorage.setItem('ai_diary_vfinal', JSON.stringify(db));
                showCalendarView();
            }
        }

        function downloadJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "my_diary_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // --- Chart Logic ---
        function updateMoodChart() {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                dates.push(d.toISOString().split('T')[0]);
            }

            const moodMap = { happy: 3, neutral: 2, sad: 1 };
            const dataPoints = dates.map(d => db[d] ? moodMap[db[d].mood] : null);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.split('-')[2] + '/' + d.split('-')[1]),
                    datasets: [{
                        data: dataPoints,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 10,
                        pointBackgroundColor: '#3b82f6',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0.5, max: 3.5, ticks: { 
                            stepSize: 1, 
                            callback: v => v==3?'üòä':v==2?'üòê':v==1?'üò¢':'' 
                        } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function searchByTag() { renderCalendar(document.getElementById('searchTag').value); }
        function changeMonth(n) { viewDate.setMonth(viewDate.getMonth() + n); renderCalendar(); }

        window.onload = init;
    </script>
</body>
</html>