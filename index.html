<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Daily Diary & Mood Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .calendar-card { min-height: 80px; transition: 0.2s; }
        .has-entry::after { content: '‚Ä¢'; color: #3b82f6; font-size: 20px; display: block; line-height: 0; }
        .hidden { display: none; }
    </style>
</head>
<body class="pb-10">

    <nav class="bg-white border-b p-4 mb-6 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-600 flex items-center gap-2 cursor-pointer" onclick="showCalendarView()">
                <i data-lucide="book-heart"></i> My Diary
            </h1>
            <div class="relative w-48 md:w-64">
                <input type="text" id="searchTag" onkeyup="searchByTag()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ #‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å..." class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-full text-sm outline-none focus:ring-2 focus:ring-blue-400">
                <i data-lucide="hash" class="w-4 h-4 absolute left-3 top-2.5 text-gray-400"></i>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4">
        
        <div id="calendar-view" class="max-w-4xl mx-auto space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-left"></i></button>
                    <h2 id="monthYearLabel" class="text-xl font-bold text-gray-700"></h2>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-right"></i></button>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <i data-lucide="bar-chart-3" class="w-5 text-blue-500"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                </h3>
                <div class="h-56 w-full">
                    <canvas id="moodChart"></canvas>
                </div>
            </div>
        </div>

        <div id="entry-view" class="hidden max-w-2xl mx-auto">
            <button onclick="showCalendarView()" class="mb-4 flex items-center gap-2 text-blue-600 hover:bg-blue-50 px-3 py-1 rounded-lg transition">
                <i data-lucide="arrow-left" class="w-4"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
            </button>
            
            <div class="bg-white p-8 rounded-3xl shadow-xl space-y-6 border border-gray-100">
                <div class="bg-blue-50 p-4 rounded-2xl border-l-4 border-blue-400">
                    <p class="text-xs font-bold text-blue-500 mb-1">AI PROMPT ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</p>
                    <p id="aiQuestion" class="text-blue-800 font-medium"></p>
                </div>

                <h2 id="viewingDateText" class="text-2xl font-bold text-gray-800"></h2>

                <div class="space-y-2">
                    <div id="imagePreview" onclick="document.getElementById('fileInput').click()" class="w-full h-48 bg-gray-50 rounded-2xl flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-200 cursor-pointer hover:bg-gray-100 transition">
                        <span class="text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImage(event)">
                </div>

                <div class="bg-gray-50 p-4 rounded-2xl flex justify-around" id="moodPicker">
                    <button onclick="setMood('happy')" id="m-happy" class="text-4xl p-2 rounded-2xl hover:bg-white transition">üòä</button>
                    <button onclick="setMood('neutral')" id="m-neutral" class="text-4xl p-2 rounded-2xl hover:bg-white transition">üòê</button>
                    <button onclick="setMood('sad')" id="m-sad" class="text-4xl p-2 rounded-2xl hover:bg-white transition">üò¢</button>
                </div>

                <textarea id="diaryBody" rows="6" class="w-full p-4 bg-gray-50 rounded-2xl focus:ring-2 focus:ring-blue-400 outline-none" placeholder="‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á..."></textarea>
                <input id="tagInput" type="text" class="w-full p-2 border-b italic outline-none text-blue-600" placeholder="#‡πÉ‡∏™‡πà‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">

                <div class="border-t pt-4">
                    <h3 class="font-bold text-gray-700 mb-3">To-Do List</h3>
                    <div id="todoList" class="space-y-2 mb-4"></div>
                    <div class="flex gap-2">
                        <input id="todoInput" type="text" class="flex-1 bg-gray-50 p-3 rounded-xl outline-none" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà...">
                        <button onclick="addTodo()" class="bg-blue-600 text-white px-4 rounded-xl hover:bg-blue-700 transition">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                </div>

                <button onclick="saveAll()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-blue-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>
    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('my_diary_v4')) || {};
        let viewDate = new Date();
        let activeDateKey = "";
        let currentMood = "";
        let currentImage = "";
        let chartInstance = null;

        const aiQuestions = [
            "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏¥‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?",
            "‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ?",
            "‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£?",
            "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÜ ‡∏ö‡πâ‡∏≤‡∏á‡πÑ‡∏´‡∏°?",
            "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?",
            "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏´‡∏•‡∏≤‡∏î‡πÉ‡∏à‡πÑ‡∏´‡∏°?",
            "‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà (1-10) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏∞‡πÑ‡∏£?"
        ];

        function init() {
            lucide.createIcons();
            renderCalendar();
            updateMoodChart();
        }

        // --- Calendar Logic ---
        function renderCalendar(filterTag = "") {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const y = viewDate.getFullYear();
            const m = viewDate.getMonth();
            document.getElementById('monthYearLabel').innerText = new Intl.DateTimeFormat('th-TH', {month:'long', year:'numeric'}).format(viewDate);

            ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'].forEach(d => grid.innerHTML += `<div class="text-center text-xs font-bold text-gray-400 pb-2">${d}</div>`);

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const entry = db[dateKey];
                
                let match = true;
                if(filterTag && (!entry || !entry.tags.includes(filterTag))) match = false;

                grid.innerHTML += `
                    <div onclick="openEntry('${dateKey}')" class="calendar-card border rounded-2xl p-2 cursor-pointer hover:shadow-md flex flex-col items-center justify-center gap-1 ${entry ? 'border-blue-300 bg-blue-50' : 'bg-white'} ${!match ? 'opacity-20' : ''}">
                        <span class="font-bold text-gray-700">${d}</span>
                        <span class="text-xs">${entry ? (entry.mood === 'happy' ? 'üòä' : entry.mood === 'neutral' ? 'üòê' : 'üò¢') : ''}</span>
                    </div>
                `;
            }
        }

        // --- Entry Management ---
        function openEntry(dateKey) {
            activeDateKey = dateKey;
            const data = db[dateKey] || { body: '', mood: '', tags: '', todos: [], img: '' };
            
            document.getElementById('calendar-view').classList.add('hidden');
            document.getElementById('entry-view').classList.remove('hidden');
            document.getElementById('viewingDateText').innerText = new Date(dateKey).toLocaleDateString('th-TH', {dateStyle:'full'});
            
            // AI Prompt
            const seed = dateKey.split('-').reduce((a, b) => a + parseInt(b), 0);
            document.getElementById('aiQuestion').innerText = aiQuestions[seed % aiQuestions.length];

            document.getElementById('diaryBody').value = data.body;
            document.getElementById('tagInput').value = data.tags;
            currentMood = data.mood;
            currentImage = data.img;
            
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = data.img ? `<img src="${data.img}" class="w-full h-full object-cover">` : '<span class="text-gray-400 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>';
            
            highlightMood(currentMood);
            renderTodos(data.todos);
            window.scrollTo(0,0);
        }

        // --- Mood Chart (Real Data) ---
        function updateMoodChart() {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days.push(d.toISOString().split('T')[0]);
            }

            const moodScores = { happy: 3, neutral: 2, sad: 1 };
            const dataPoints = last7Days.map(date => db[date] ? moodScores[db[date].mood] : null);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => d.split('-')[2] + '/' + d.split('-')[1]),
                    datasets: [{
                        label: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå',
                        data: dataPoints,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 6,
                        pointBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            min: 1, max: 3, 
                            ticks: { 
                                stepSize: 1,
                                callback: value => value === 3 ? 'üòä' : value === 2 ? 'üòê' : value === 1 ? 'üò¢' : ''
                            } 
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Functions ---
        function saveAll() {
            db[activeDateKey] = {
                body: document.getElementById('diaryBody').value,
                mood: currentMood,
                tags: document.getElementById('tagInput').value,
                img: currentImage,
                todos: Array.from(document.querySelectorAll('#todoList div')).map(el => ({
                    text: el.querySelector('span').innerText,
                    done: el.querySelector('input').checked
                })),
                updatedAt: new Date().toISOString()
            };
            localStorage.setItem('my_diary_v4', JSON.stringify(db));
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ú®");
            showCalendarView();
        }

        function handleImage(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    currentImage = ev.target.result;
                    document.getElementById('imagePreview').innerHTML = `<img src="${currentImage}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function searchByTag() { renderCalendar(document.getElementById('searchTag').value); }
        function showCalendarView() { document.getElementById('calendar-view').classList.remove('hidden'); document.getElementById('entry-view').classList.add('hidden'); renderCalendar(); updateMoodChart(); }
        function changeMonth(n) { viewDate.setMonth(viewDate.getMonth() + n); renderCalendar(); }
        function setMood(m) { currentMood = m; highlightMood(m); }
        function highlightMood(m) { ['happy','neutral','sad'].forEach(id => document.getElementById('m-'+id).classList.toggle('bg-blue-100', id === m)); }
        function addTodo() {
            const val = document.getElementById('todoInput').value;
            if(!val) return;
            document.getElementById('todoList').innerHTML += `<div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg"><input type="checkbox"> <span class="text-sm">${val}</span></div>`;
            document.getElementById('todoInput').value = '';
        }
        function renderTodos(todos) {
            document.getElementById('todoList').innerHTML = (todos || []).map(t => `<div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg"><input type="checkbox" ${t.done?'checked':''}> <span class="text-sm">${t.text}</span></div>`).join('');
        }

        window.onload = init;
    </script>
</body>
</html>