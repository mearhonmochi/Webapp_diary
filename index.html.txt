<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Diary & Mood Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .active-date { background-color: #2563eb !important; color: white !important; }
        .mood-selected { border: 2px solid #2563eb; transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-blue-600 text-xl">
                <i data-lucide="book-marked"></i> ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
            </div>
            <div class="flex gap-4 items-center">
                <button onclick="exportData('json')" class="text-xs bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">JSON</button>
                <button onclick="exportPDF()" class="text-xs bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">PDF</button>
                <button class="text-blue-600 font-medium text-sm">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="monthDisplay" class="font-semibold"></h2>
                    <div class="flex gap-1">
                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-gray-100 rounded"><i data-lucide="chevron-left" class="w-5"></i></button>
                        <button onclick="changeMonth(1)" class="p-1 hover:bg-gray-100 rounded"><i data-lucide="chevron-right" class="w-5"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-gray-400 mb-2">
                    <div>‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm text-center"></div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="line-chart" class="w-4 text-blue-500"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                </h3>
                <canvas id="moodChart" height="200"></canvas>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6">
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 id="selectedDateText" class="text-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
                        <p id="aiPrompt" class="text-sm text-blue-500 mt-1 cursor-pointer italic" onclick="newPrompt()">
                            AI: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏¥‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?
                        </p>
                    </div>
                    <div class="flex gap-2" id="moodPicker">
                        <button onclick="selectMood('1')" class="p-2 rounded-lg bg-gray-50 hover:bg-yellow-100" title="‡∏î‡∏µ‡πÉ‡∏à">üòä</button>
                        <button onclick="selectMood('2')" class="p-2 rounded-lg bg-gray-50 hover:bg-gray-100" title="‡πÄ‡∏â‡∏¢‡πÜ">üòê</button>
                        <button onclick="selectMood('3')" class="p-2 rounded-lg bg-gray-50 hover:bg-blue-100" title="‡πÄ‡∏®‡∏£‡πâ‡∏≤">üò¢</button>
                        <button onclick="selectMood('4')" class="p-2 rounded-lg bg-gray-50 hover:bg-purple-100" title="‡πÄ‡∏ö‡∏∑‡πà‡∏≠">ü•±</button>
                    </div>
                </div>

                <textarea id="diaryText" class="w-full p-4 border rounded-xl h-48 focus:ring-2 focus:ring-blue-500 outline-none mb-4" placeholder="‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢..."></textarea>
                
                <input id="tagInput" type="text" class="w-full p-2 border-b text-sm mb-4 outline-none focus:border-blue-500" placeholder="‡∏ï‡∏¥‡∏î‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å ‡πÄ‡∏ä‡πà‡∏ô #‡∏ó‡∏≥‡∏á‡∏≤‡∏ô #‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß">

                <div class="mt-4 border-t pt-4">
                    <h3 class="font-semibold mb-3 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-4 text-green-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (To-Do)
                    </h3>
                    <div id="todoList" class="space-y-2 mb-3 text-sm"></div>
                    <div class="flex gap-2">
                        <input id="todoInput" type="text" class="flex-1 p-2 border rounded-lg text-sm" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà...">
                        <button onclick="addTodo()" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button onclick="saveAll()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-100 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button onclick="deleteEntry()" class="p-3 bg-red-50 text-red-500 rounded-xl hover:bg-red-100"><i data-lucide="trash-2"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="pdpa" class="fixed bottom-0 inset-x-0 bg-white border-t p-4 shadow-2xl flex flex-col md:flex-row justify-between items-center gap-4 z-50">
        <p class="text-xs text-gray-500">‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ PDPA ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</p>
        <button onclick="document.getElementById('pdpa').remove()" class="bg-gray-800 text-white px-6 py-2 rounded-lg text-sm">‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
    </div>

    <script>
        // Data & State
        let db = JSON.parse(localStorage.getItem('diary_v2')) || {};
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentMood = null;
        let chartInstance = null;

        const prompts = [
            "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏¥‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?",
            "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?",
            "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÜ ‡∏ö‡πâ‡∏≤‡∏á?",
            "‡∏ñ‡πâ‡∏≤‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô?"
        ];

        // Initialization
        function init() {
            lucide.createIcons();
            renderCalendar();
            loadEntry(selectedDate);
            updateChart();
            checkReminder();
        }

        // 1. Calendar Logic
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthText = document.getElementById('monthDisplay');
            grid.innerHTML = '';
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            
            monthText.innerText = `${months[currentMonth]} ${currentYear + 543}`;

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasData = db[dateStr] ? 'border-b-2 border-blue-400' : '';
                const isSelected = dateStr === selectedDate ? 'active-date shadow-lg' : 'bg-white hover:bg-blue-50';
                
                grid.innerHTML += `<button onclick="changeDate('${dateStr}')" class="p-2 rounded-lg transition ${isSelected} ${hasData}">${d}</button>`;
            }
        }

        // 2. Diary & Mood Logic
        function loadEntry(date) {
            const entry = db[date] || { content: '', mood: null, tags: '', todos: [] };
            document.getElementById('diaryText').value = entry.content;
            document.getElementById('tagInput').value = entry.tags;
            document.getElementById('selectedDateText').innerText = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date(date).toLocaleDateString('th-TH')}`;
            currentMood = entry.mood;
            renderTodos(entry.todos || []);
            highlightMood(entry.mood);
        }

        function saveAll() {
            if (!db[selectedDate]) db[selectedDate] = {};
            db[selectedDate].content = document.getElementById('diaryText').value;
            db[selectedDate].tags = document.getElementById('tagInput').value;
            db[selectedDate].mood = currentMood;
            db[selectedDate].updatedAt = new Date().toISOString();
            
            localStorage.setItem('diary_v2', JSON.stringify(db));
            renderCalendar();
            updateChart();
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }

        function selectMood(m) {
            currentMood = m;
            highlightMood(m);
        }

        function highlightMood(m) {
            document.querySelectorAll('#moodPicker button').forEach((btn, idx) => {
                btn.classList.toggle('mood-selected', (idx + 1).toString() === m);
            });
        }

        // 3. To-Do List Logic
        let currentTodos = [];
        function renderTodos(todos) {
            currentTodos = todos;
            const container = document.getElementById('todoList');
            container.innerHTML = todos.map((t, i) => `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" ${t.done ? 'checked' : ''} onclick="toggleTodo(${i})">
                        <span class="${t.done ? 'line-through text-gray-400' : ''}">${t.text}</span>
                    </div>
                    <button onclick="removeTodo(${i})" class="text-red-400 hover:text-red-600"><i data-lucide="x" class="w-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function addTodo() {
            const input = document.getElementById('todoInput');
            if (!input.value) return;
            currentTodos.push({ text: input.value, done: false });
            if (!db[selectedDate]) db[selectedDate] = { todos: [] };
            db[selectedDate].todos = currentTodos;
            input.value = '';
            renderTodos(currentTodos);
        }

        function toggleTodo(i) {
            currentTodos[i].done = !currentTodos[i].done;
            db[selectedDate].todos = currentTodos;
            renderTodos(currentTodos);
        }

        // 4. Statistics Chart (Req 1.4)
        function updateChart() {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const last7Days = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toISOString().split('T')[0];
            });

            const moodValues = last7Days.map(d => db[d]?.mood || 0);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => d.split('-')[2]),
                    datasets: [{
                        label: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå',
                        data: moodValues,
                        borderColor: '#3b82f6',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }]
                },
                options: { scales: { y: { min: 0, max: 4, ticks: { stepSize: 1 } } } }
            });
        }

        // 5. Utility Functions
        function changeDate(d) { selectedDate = d; loadEntry(d); renderCalendar(); }
        function changeMonth(s) { currentMonth += s; renderCalendar(); }
        function newPrompt() { document.getElementById('aiPrompt').innerText = "AI: " + prompts[Math.floor(Math.random()*prompts.length)]; }
        
        function exportData(type) {
            const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diary_backup_${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        function exportPDF() { alert("‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô PDF ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢..."); }

        function checkReminder() {
            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Req 1.4)
            setTimeout(() => {
                if (!db[new Date().toISOString().split('T')[0]]) {
                    console.log("Reminder: ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏à!");
                }
            }, 2000);
        }

        window.onload = init;
    </script>
</body>
</html>